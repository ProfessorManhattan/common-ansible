---
version: '3'

tasks:
{{#if dockerfile}}
  snyk-login:
    deps:
      - :npm:snyk
    env:
      SNYK_API_TOKEN:
        sh: snyk config get api
    cmds:
      - |
        if [ -z "$SNYK_API_TOKEN" ]; then
          t info "You are currently not authenticated with Snyk. Initiating the sign-in process for Snyk by running 'snyk auth'"
          snyk auth
        fi

  snyk:
    deps:
      - :npm:snyk
      - :software:jq
    desc: Analyze the Docker container for security vulnerabilities with Snyk (requires login)
    summary: |
      $ Analyze the Docker container with Snyk

      One of the services Snyk provides is the capability to identify Docker container vulnerabilities. These
      vulnerabilities can potentially be used by bad actors. Normally, care should be taken to fix
      the vulnerabilities Snyk reports whenever possible. To use Snyk, you must be authenticated with their
      service. Signing up is free and easy (albeit, there is a limit to the number of scans you can run for free).
      All you have to do is run `snyk auth` with the `snyk` NPM package installed.

      For more information on Snyk, see: https://snyk.io/what-is-snyk/
    vars:
      DOCKER_IMAGE:
        sh: jq -r '.slug' .variables.json
    cmds:
      - task: snyk-login
      - t info "Scanning '{{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:latest' for vulnerabilities with Snyk"
      - snyk test --docker {{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:latest --file=Dockerfile
      - t info "Scanning '{{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:slim' for vulnerabilities with Snyk"
      - snyk test --docker {{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:slim --file=Dockerfile

  trivy:
    deps:
      - :software:jq
      - :software:trivy
    desc: Analyze the Docker container for security vulnerabilities with Trivy
    summary: |
      $ Analyze the Docker container with Trivy

      Trivy is a simple and comprehensive vulnerability and misconfiguration scanner for containers
      and other artifacts. This task leverages Trivy's ability to report possible vulnerabilities in
      the Docker container.

      For more information on Trivy, see: https://aquasecurity.github.io/trivy/
    vars:
      DOCKER_IMAGE:
        sh: jq -r '.slug' .variables.json
    cmds:
      - t info "Scanning '{{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:latest' for vulnerabilities with Trivy"
      - trivy image {{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:latest
      - t info "Scanning '{{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:slim' for vulnerabilities with Trivy"
      - trivy image {{profile.dockerhub}}/\{{.DOCKER_IMAGE}}:slim

{{/if}}
