---
version: '3'

tasks:
  all:
    desc: Lint the project by running all the linters in parallel
    deps: [lint:formatting{{#if hbs.ansible}} ,lint:ansible{{/if}}{{#if hbs.dockerfile}}, lint:docker{{/if}}{{#if hbs.python}}, lint-python{{/if}}{{#if hbs.yaml}}, lint-yaml{{/if}}]
{{#if hbs.ansible}}

  ansible:
    deps: [:ansible:symlink]
    desc: Lint Ansible projects using Ansible Lint
    cmds:
      - ansible-lint
    sources:
      - defaults/**/*
      - environments/**/*
      - group_vars/**/*
      - host_vars/**/*
      - inventories/**/*
      - meta/**/*
      - molecule/**/*
      - playbooks/**/*
      - tasks/**/*
      - tests/**/*
      - vars/**/*
      - ./*.yml
    method: checksum
{{/if}}
{{#if hbs.dockerfile}}

  docker:
    desc: Lint Dockerfiles using Hadolint (requires Docker)
    cmds:
      - find . -type d \( -name .cache -o -name .common -o -name .git -o -name .modules
        -o -name node_modules -o -name .husky -o -name .task -o -name test \) -prune -o
        -type f \( -name Dockerfile -o -name Dockerfile.j2 \) -print0 | xargs -0 -r -n1
        docker run -v "$PWD:/work" -w /work megabytelabs/hadolint:slim
    sources:
      - ./**Dockerfile
      - ./**Dockerfile.j2
    method: checksum
{{/if}}
{{#if hbs.python}}

  python:
    desc: Lint Python files using Flake8
    cmds:
      - flake8 .
{{/if}}
{{#if hbs.yaml}}

  yaml:
    desc: Lint .yml files using YAML Lint
    cmds:
      - yamllint -s .
{{/if}}
{{#if hbs.ansible}}

  yaml:
    desc: Lint .yml files using YAML Lint
    cmds:
      - yamllint -s .
    sources:
      - defaults/**/*
      - environments/**/*
      - group_vars/**/*
      - host_vars/**/*
      - inventories/**/*
      - meta/**/*
      - molecule/**/*
      - playbooks/**/*
      - tasks/**/*
      - tests/**/*
      - vars/**/*
      - ./*.yml
    method: checksum

{{/if}}
